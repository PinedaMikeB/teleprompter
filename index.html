<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>WOTG Teleprompter</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0a0a0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0a;--text:#e0e0e0;--accent:#4fc3f7;--panel:rgba(20,20,40,.85);
  --border:rgba(255,255,255,.15);--font-size:36px;--text-width:90%;
  --line-height:1.6;--text-opacity:0.92;--margin-top:40vh;
}
html,body{height:100%;overflow:hidden;font-family:system-ui,-apple-system,sans-serif}
body{background:var(--bg);color:var(--text);transition:background .3s,color .3s}
body.light{--bg:#f0f0f0;--text:#111;--panel:rgba(255,255,255,.9);--border:rgba(0,0,0,.15);--accent:#0277bd}

/* === CAMERA LAYER === */
#cameraLayer{
  position:fixed;inset:0;z-index:0;background:#000;
  display:none; /* hidden until camera starts */
}
#cameraLayer video{
  width:100%;height:100%;object-fit:cover;
  transform:scaleX(-1); /* selfie mirror */
}
body.camera-on #cameraLayer{display:block}
body.camera-on{--bg:transparent}
body.camera-on .scroll-content{
  text-shadow:0 1px 8px rgba(0,0,0,.9),0 0 20px rgba(0,0,0,.6);
}

/* === SCROLL AREA === */
.scroll-area{position:fixed;inset:0;z-index:5;overflow:hidden}
.scroll-content{
  padding-top:var(--margin-top);padding-bottom:60vh;
  width:var(--text-width);max-width:100%;margin:0 auto;
  font-size:var(--font-size);line-height:var(--line-height);
  white-space:pre-wrap;word-wrap:break-word;
  opacity:var(--text-opacity);
  transition:opacity .2s;
}

/* Mirror text */
body.mirror .scroll-content{transform:scaleX(-1)}

/* === GUIDE LINE === */
.guide-line{
  position:fixed;left:0;right:0;height:2px;background:var(--accent);
  opacity:.4;pointer-events:none;z-index:10;top:30%;
}

/* === RECORDING INDICATOR === */
.rec-indicator{
  position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:120;
  display:none;align-items:center;gap:8px;
  background:rgba(229,57,53,.9);color:#fff;
  padding:6px 16px;border-radius:20px;font-size:13px;font-weight:700;
}
.rec-indicator.show{display:flex}
.rec-dot{
  width:10px;height:10px;border-radius:50%;background:#fff;
  animation:blink 1s infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.rec-timer{font-variant-numeric:tabular-nums}

/* === TOOLBAR === */
.toolbar{
  position:fixed;top:0;left:0;right:0;z-index:100;
  background:var(--panel);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:5px;padding:6px 8px;
  font-size:13px;flex-wrap:wrap;transition:transform .3s;
}
.toolbar.hidden{transform:translateY(-100%)}
.toolbar button{
  background:rgba(255,255,255,.1);color:var(--text);border:none;border-radius:8px;
  padding:6px 10px;font-size:14px;cursor:pointer;min-height:36px;
  display:flex;align-items:center;justify-content:center;
  transition:background .15s;
}
.toolbar button:active{transform:scale(.95)}
.toolbar button.active{background:var(--accent);color:#000}
.toolbar .spacer{flex:1}
.toolbar .group{display:flex;align-items:center;gap:3px}
.speed-display{
  min-width:28px;text-align:center;font-weight:bold;font-size:14px;color:var(--accent);
}

/* === BOTTOM BAR === */
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;align-items:center;justify-content:center;gap:8px;
  padding:10px 16px 24px;
  background:linear-gradient(transparent,rgba(0,0,0,.6) 40%);
}
body:not(.camera-on) .bottom-bar{background:linear-gradient(transparent,var(--bg) 40%)}
.bottom-bar button{
  background:var(--panel);backdrop-filter:blur(8px);
  color:var(--text);border:1px solid var(--border);
  border-radius:50%;width:48px;height:48px;font-size:20px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.bottom-bar .play-btn{
  width:60px;height:60px;font-size:26px;
  background:var(--accent);color:#000;border:none;
}
.bottom-bar .rec-btn{
  background:rgba(229,57,53,.8);color:#fff;border:none;
}
.bottom-bar .rec-btn.recording{
  background:#e53935;animation:pulse-rec 1.5s infinite;
}
@keyframes pulse-rec{0%,100%{box-shadow:0 0 0 0 rgba(229,57,53,.5)}50%{box-shadow:0 0 0 12px rgba(229,57,53,0)}}
.bottom-bar button:active{transform:scale(.92)}

/* === MODALS === */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;
  display:none;align-items:center;justify-content:center;padding:16px;
  backdrop-filter:blur(4px);
}
.modal-overlay.show{display:flex}
.modal{
  background:var(--panel);backdrop-filter:blur(16px);
  border:1px solid var(--border);border-radius:16px;
  width:100%;max-width:700px;max-height:90vh;display:flex;flex-direction:column;
  overflow:hidden;
}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid var(--border);
}
.modal-header h2{font-size:16px}
.modal textarea{
  flex:1;min-height:40vh;padding:16px;font-size:16px;line-height:1.5;
  background:rgba(0,0,0,.3);color:var(--text);border:none;resize:none;
  font-family:inherit;
}
.modal-footer{
  display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border);
}
.modal-footer button{
  flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;
  cursor:pointer;font-weight:600;
}
.btn-primary{background:var(--accent);color:#000}
.btn-secondary{background:rgba(255,255,255,.1);color:var(--text)}

/* === SCRIPTS LIST === */
.scripts-list{flex:1;overflow-y:auto;padding:8px}
.script-item{
  display:flex;align-items:center;padding:12px;border-radius:10px;
  margin-bottom:4px;cursor:pointer;gap:10px;
}
.script-item:active{background:rgba(255,255,255,.08)}
.script-item .title{flex:1;font-size:14px}
.script-item .date{font-size:11px;opacity:.5}
.script-item .del-btn{
  background:none;border:none;color:#e53935;font-size:16px;cursor:pointer;
  padding:6px 8px;border-radius:6px;
}

/* === SETTINGS PANEL === */
.settings-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;
  display:none;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(4px);
}
.settings-overlay.show{display:flex}
.settings-panel{
  background:var(--panel);backdrop-filter:blur(16px);
  border:1px solid var(--border);
  border-radius:20px 20px 0 0;width:100%;max-width:500px;
  max-height:80vh;overflow-y:auto;padding:20px 16px 36px;
}
.settings-panel h3{font-size:15px;margin-bottom:16px;color:var(--accent)}
.setting-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 0;border-bottom:1px solid var(--border);
}
.setting-row label{font-size:13px;flex:1}
.setting-row input[type=range]{width:110px;accent-color:var(--accent)}
.setting-row .val{min-width:42px;text-align:right;font-size:12px;opacity:.7}
.setting-row select{
  background:rgba(255,255,255,.1);color:var(--text);border:1px solid var(--border);
  border-radius:8px;padding:6px 10px;font-size:13px;
}

/* === EMPTY STATE === */
.empty-state{text-align:center;padding-top:30vh;opacity:.4}
.empty-state p{font-size:18px;margin-bottom:8px}

/* === INSTALL BANNER === */
.install-banner{
  position:fixed;bottom:80px;left:16px;right:16px;z-index:110;
  background:var(--panel);backdrop-filter:blur(12px);
  border:1px solid var(--accent);border-radius:14px;
  padding:14px 16px;display:none;align-items:center;gap:12px;
}
.install-banner.show{display:flex}
.install-banner p{flex:1;font-size:13px;line-height:1.4}
.install-banner button{
  background:var(--accent);color:#000;border:none;border-radius:8px;
  padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap;
}
.install-banner .close-banner{
  background:none;color:var(--text);padding:4px;font-size:18px;
}

/* Scrollbar hide */
::-webkit-scrollbar{display:none}
</style>
</head>
<body>

<!-- CAMERA LAYER -->
<div id="cameraLayer">
  <video id="cameraVideo" autoplay playsinline muted></video>
</div>

<!-- RECORDING INDICATOR -->
<div class="rec-indicator" id="recIndicator">
  <div class="rec-dot"></div>
  <span>REC</span>
  <span class="rec-timer" id="recTimer">00:00</span>
</div>

<!-- GUIDE LINE -->
<div class="guide-line" id="guideLine"></div>

<!-- SCROLL AREA -->
<div class="scroll-area" id="scrollArea">
  <div class="scroll-content" id="scrollContent">
    <div class="empty-state" id="emptyState">
      <p>üìú No script loaded</p>
      <p style="font-size:14px">Tap ‚úèÔ∏è to create or üìÅ to load a script</p>
    </div>
  </div>
</div>

<!-- TOOLBAR -->
<div class="toolbar" id="toolbar">
  <button onclick="openScripts()" title="Scripts">üìÅ</button>
  <button onclick="openEditor()" title="New/Edit">‚úèÔ∏è</button>
  <div class="spacer"></div>
  <div class="group">
    <button onclick="changeSpeed(-0.5)">‚àí</button>
    <span class="speed-display" id="speedDisplay">3</span>
    <button onclick="changeSpeed(0.5)">+</button>
  </div>
  <button onclick="toggleCamera()" id="cameraBtn" title="Camera">üì∑</button>
  <button onclick="toggleMirror()" id="mirrorBtn" title="Mirror">ü™û</button>
  <button onclick="toggleTheme()" id="themeBtn" title="Theme">üåô</button>
  <button onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
</div>

<!-- BOTTOM CONTROLS -->
<div class="bottom-bar" id="bottomBar">
  <button onclick="resetScroll()" title="Reset">‚èÆ</button>
  <button onclick="nudge(-1)" title="Back">‚è™</button>
  <button class="play-btn" onclick="togglePlay()" id="playBtn" title="Play/Pause">‚ñ∂</button>
  <button onclick="nudge(1)" title="Forward">‚è©</button>
  <button class="rec-btn" onclick="toggleRecording()" id="recBtn" title="Record">‚è∫</button>
  <button onclick="toggleToolbar()" title="Toggle UI">üëÅ</button>
</div>

<!-- INSTALL BANNER -->
<div class="install-banner" id="installBanner">
  <p>üì± <strong>Install WOTG Teleprompter</strong> for the best experience</p>
  <button onclick="installApp()">Install</button>
  <button class="close-banner" onclick="dismissInstall()">‚úï</button>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editorModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="editorTitle">New Script</h2>
      <button onclick="closeEditor()" style="background:none;border:none;color:var(--text);font-size:20px;cursor:pointer">‚úï</button>
    </div>
    <input type="text" id="scriptNameInput" placeholder="Script title..."
      style="padding:12px 16px;font-size:15px;border:none;border-bottom:1px solid var(--border);background:rgba(0,0,0,.3);color:var(--text)">
    <textarea id="scriptTextarea" placeholder="Paste or type your script here..."></textarea>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeEditor()">Cancel</button>
      <button class="btn-primary" onclick="saveScript()">üíæ Save & Load</button>
    </div>
  </div>
</div>

<!-- SCRIPTS LIST MODAL -->
<div class="modal-overlay" id="scriptsModal">
  <div class="modal">
    <div class="modal-header">
      <h2>üìÅ Saved Scripts</h2>
      <button onclick="closeScripts()" style="background:none;border:none;color:var(--text);font-size:20px;cursor:pointer">‚úï</button>
    </div>
    <div class="scripts-list" id="scriptsList"></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeScripts()">Close</button>
      <button class="btn-primary" onclick="closeScripts();openEditor()">+ New Script</button>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel">
    <h3>‚öôÔ∏è Display Settings</h3>

    <div class="setting-row">
      <label>Font Size</label>
      <input type="range" min="16" max="80" value="36" id="fontSizeSlider" oninput="updateSetting('fontSize',this.value)">
      <span class="val" id="fontSizeVal">36px</span>
    </div>
    <div class="setting-row">
      <label>Line Height</label>
      <input type="range" min="1" max="3" step="0.1" value="1.6" id="lineHeightSlider" oninput="updateSetting('lineHeight',this.value)">
      <span class="val" id="lineHeightVal">1.6</span>
    </div>
    <div class="setting-row">
      <label>Text Width</label>
      <input type="range" min="40" max="100" value="90" id="textWidthSlider" oninput="updateSetting('textWidth',this.value)">
      <span class="val" id="textWidthVal">90%</span>
    </div>
    <div class="setting-row">
      <label>Top Margin</label>
      <input type="range" min="5" max="60" value="40" id="marginTopSlider" oninput="updateSetting('marginTop',this.value)">
      <span class="val" id="marginTopVal">40%</span>
    </div>
    <div class="setting-row">
      <label>Guide Position</label>
      <input type="range" min="10" max="60" value="30" id="guideSlider" oninput="updateSetting('guide',this.value)">
      <span class="val" id="guideVal">30%</span>
    </div>
    <div class="setting-row">
      <label>Text Opacity</label>
      <input type="range" min="10" max="100" value="92" id="opacitySlider" oninput="updateSetting('textOpacity',this.value)">
      <span class="val" id="textOpacityVal">92%</span>
    </div>
    <div class="setting-row">
      <label>Nudge Step</label>
      <input type="range" min="0.5" max="10" step="0.5" value="1" id="nudgeSizeSlider" oninput="updateSetting('nudgeSize',this.value)">
      <span class="val" id="nudgeSizeVal">1 line</span>
    </div>
    <div class="setting-row">
      <label>Font Family</label>
      <select id="fontSelect" onchange="updateSetting('fontFamily',this.value)">
        <option value="Georgia, serif">Georgia</option>
        <option value="system-ui, sans-serif">System UI</option>
        <option value="'Courier New', monospace">Courier</option>
        <option value="'Arial', sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times</option>
        <option value="'Verdana', sans-serif">Verdana</option>
      </select>
    </div>
    <div class="setting-row">
      <label>Camera</label>
      <select id="cameraSelect" onchange="switchCamera(this.value)">
        <option value="user">Front (Selfie)</option>
        <option value="environment">Back</option>
      </select>
    </div>

    <div style="margin-top:16px;text-align:center">
      <button class="btn-secondary" onclick="resetSettings()" style="padding:8px 20px;border:none;border-radius:8px;cursor:pointer">
        Reset Defaults
      </button>
    </div>

    <h3 style="margin-top:24px">üéÆ Bluetooth Remote</h3>
    <div style="padding:8px 0;font-size:13px;opacity:.7;line-height:1.5">
      Pair your Desview or any Bluetooth remote/clicker in your phone's Bluetooth settings. It works automatically ‚Äî the joystick/buttons control scrolling, play/pause, and more.
    </div>
    <div class="setting-row">
      <label>Test Remote Keys</label>
      <button id="keyDebugBtn" onclick="toggleKeyDebug()" 
        style="background:rgba(255,255,255,.1);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-size:13px;cursor:pointer">
        üéÆ Start Debug
      </button>
    </div>
    <div style="padding:8px 0;font-size:11px;opacity:.5;line-height:1.5">
      <strong>Default key mapping:</strong><br>
      Joystick ‚Üë‚Üì / Arrows / Vol = Scroll forward/backward<br>
      Center / Enter / Space = Play/Pause<br>
      [ ] or +/- = Speed up/down<br>
      Home / R = Reset ¬∑ M = Mirror ¬∑ C = Camera
    </div>
  </div>
</div>

<script>
// =============================================
// DATABASE (IndexedDB)
// =============================================
const DB_NAME = 'TeleprompterDB', DB_VER = 1, STORE = 'scripts';
let db;

function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB_NAME, DB_VER);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(STORE))
        d.createObjectStore(STORE, { keyPath: 'id' }).createIndex('updated', 'updated');
    };
    r.onsuccess = e => { db = e.target.result; res(db); };
    r.onerror = e => rej(e);
  });
}
function dbPut(s) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).put(s); tx.oncomplete = () => res(); tx.onerror = rej;
  });
}
function dbGetAll() {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readonly');
    const r = tx.objectStore(STORE).getAll();
    r.onsuccess = () => res(r.result.sort((a, b) => b.updated - a.updated));
    r.onerror = rej;
  });
}
function dbGet(id) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readonly');
    const r = tx.objectStore(STORE).get(id);
    r.onsuccess = () => res(r.result); r.onerror = rej;
  });
}
function dbDelete(id) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).delete(id); tx.oncomplete = () => res(); tx.onerror = rej;
  });
}

// =============================================
// STATE
// =============================================
let speed = 3, isPlaying = false, scrollY = 0, animFrame = null, lastTime = 0;
let currentScriptId = null, editingScriptId = null;
let toolbarVisible = true, isMirror = false, isLight = false;
let cameraStream = null, cameraOn = false;
let mediaRecorder = null, recordedChunks = [], isRecording = false;
let recStartTime = 0, recTimerInterval = null;

// =============================================
// SETTINGS
// =============================================
const defaults = {
  fontSize:36, lineHeight:1.6, textWidth:90, marginTop:40,
  guide:30, fontFamily:'Georgia, serif', textOpacity:92, nudgeSize:1
};

function loadSettings() {
  const s = JSON.parse(localStorage.getItem('tp_settings')||'null') || {...defaults};
  applySettings(s); return s;
}

function applySettings(s) {
  const el = document.getElementById('scrollContent');
  el.style.fontSize = s.fontSize+'px';
  el.style.lineHeight = s.lineHeight;
  el.style.width = s.textWidth+'%';
  el.style.paddingTop = s.marginTop+'vh';
  el.style.fontFamily = s.fontFamily;
  el.style.opacity = (s.textOpacity||92)/100;
  document.documentElement.style.setProperty('--text-opacity', (s.textOpacity||92)/100);
  document.getElementById('guideLine').style.top = s.guide+'%';

  // Update UI controls
  const map = {fontSize:'px',lineHeight:'',textWidth:'%',marginTop:'%',guide:'%',textOpacity:'%'};
  Object.entries(map).forEach(([k,suffix]) => {
    const sl = document.getElementById(k+'Slider');
    const vl = document.getElementById(k+'Val');
    if (sl) sl.value = s[k]||defaults[k];
    if (vl) vl.textContent = (s[k]||defaults[k])+suffix;
  });
  const fs = document.getElementById('fontSelect');
  if (fs) fs.value = s.fontFamily;
  // Nudge size slider
  const ns = document.getElementById('nudgeSizeSlider');
  const nv = document.getElementById('nudgeSizeVal');
  const nval = s.nudgeSize || 1;
  if (ns) ns.value = nval;
  if (nv) nv.textContent = nval + (nval === 1 ? ' line' : ' lines');
}

function updateSetting(key, val) {
  const s = JSON.parse(localStorage.getItem('tp_settings')||'null') || {...defaults};
  s[key] = isNaN(val) ? val : parseFloat(val);
  localStorage.setItem('tp_settings', JSON.stringify(s));
  applySettings(s);
}

function resetSettings() {
  localStorage.setItem('tp_settings', JSON.stringify({...defaults}));
  applySettings(defaults);
}

function openSettings() { document.getElementById('settingsOverlay').classList.add('show'); }
function closeSettings() { document.getElementById('settingsOverlay').classList.remove('show'); }
</script>

<script>
// =============================================
// SCROLL ENGINE
// =============================================
function startScroll() {
  lastTime = performance.now();
  function step(now) {
    if (!isPlaying) return;
    const dt = (now - lastTime) / 1000;
    lastTime = now;
    scrollY += speed * 30 * dt;
    applyTransform();
    animFrame = requestAnimationFrame(step);
  }
  animFrame = requestAnimationFrame(step);
}

function stopScroll() { if (animFrame) cancelAnimationFrame(animFrame); }

function togglePlay() {
  isPlaying = !isPlaying;
  document.getElementById('playBtn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
  if (isPlaying) startScroll(); else stopScroll();
}

function resetScroll() {
  isPlaying = false; stopScroll(); scrollY = 0;
  document.getElementById('playBtn').textContent = '‚ñ∂';
  applyTransform();
}

function changeSpeed(delta) {
  speed = Math.max(0.5, Math.min(20, +(speed + delta).toFixed(1)));
  document.getElementById('speedDisplay').textContent = speed % 1 === 0 ? speed : speed.toFixed(1);
  localStorage.setItem('tp_speed', speed);
}

function nudge(dir) {
  const s = JSON.parse(localStorage.getItem('tp_settings')||'null') || defaults;
  const lines = s.nudgeSize || 1; // how many lines per nudge press
  scrollY = Math.max(0, scrollY + s.fontSize * s.lineHeight * lines * dir);
  applyTransform();
}

function applyTransform() {
  document.getElementById('scrollContent').style.transform =
    `translateY(${-scrollY}px)` + (isMirror ? ' scaleX(-1)' : '');
}

// =============================================
// MIRROR & THEME
// =============================================
function toggleMirror() {
  isMirror = !isMirror;
  document.getElementById('mirrorBtn').classList.toggle('active', isMirror);
  applyTransform();
  localStorage.setItem('tp_mirror', isMirror);
}

function toggleTheme() {
  isLight = !isLight;
  document.body.classList.toggle('light', isLight);
  document.getElementById('themeBtn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('tp_theme', isLight ? 'light' : 'dark');
}

function toggleToolbar() {
  toolbarVisible = !toolbarVisible;
  document.getElementById('toolbar').classList.toggle('hidden', !toolbarVisible);
}

// =============================================
// CAMERA
// =============================================
async function toggleCamera() {
  if (cameraOn) {
    stopCamera();
  } else {
    await startCamera();
  }
}

async function startCamera(facingMode) {
  facingMode = facingMode || localStorage.getItem('tp_cam_facing') || 'user';
  try {
    if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); }
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facingMode, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    cameraStream = stream;
    const video = document.getElementById('cameraVideo');
    video.srcObject = stream;
    video.style.transform = facingMode === 'user' ? 'scaleX(-1)' : 'none';
    document.body.classList.add('camera-on');
    document.getElementById('cameraBtn').classList.add('active');
    cameraOn = true;
    localStorage.setItem('tp_cam_facing', facingMode);
  } catch (err) {
    alert('Camera access denied. Please allow camera permissions.');
    console.error('Camera error:', err);
  }
}

function stopCamera() {
  if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
  document.body.classList.remove('camera-on');
  document.getElementById('cameraBtn').classList.remove('active');
  document.getElementById('cameraVideo').srcObject = null;
  cameraOn = false;
}

function switchCamera(facingMode) {
  if (cameraOn) { startCamera(facingMode); }
  localStorage.setItem('tp_cam_facing', facingMode);
}

// =============================================
// VIDEO RECORDING
// =============================================
async function toggleRecording() {
  if (isRecording) {
    stopRecording();
  } else {
    await startRecording();
  }
}

async function startRecording() {
  // Ensure camera is on
  if (!cameraOn) await startCamera();
  if (!cameraStream) return;

  try {
    // Create a combined stream: video from camera + audio from mic
    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const combined = new MediaStream([
      ...cameraStream.getVideoTracks(),
      ...audioStream.getAudioTracks()
    ]);

    recordedChunks = [];
    const options = { mimeType: getSupportedMime() };
    mediaRecorder = new MediaRecorder(combined, options);

    mediaRecorder.ondataavailable = e => {
      if (e.data && e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: options.mimeType });
      const url = URL.createObjectURL(blob);
      // Create download link
      const a = document.createElement('a');
      a.href = url;
      const ts = new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
      a.download = `teleprompter-${ts}.webm`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 5000);
      // Cleanup audio tracks
      audioStream.getTracks().forEach(t => t.stop());
    };

    mediaRecorder.start(1000); // collect chunks every second
    isRecording = true;
    recStartTime = Date.now();

    // UI updates
    document.getElementById('recBtn').classList.add('recording');
    document.getElementById('recBtn').textContent = '‚èπ';
    document.getElementById('recIndicator').classList.add('show');
    recTimerInterval = setInterval(updateRecTimer, 1000);
    updateRecTimer();

  } catch (err) {
    alert('Could not start recording. Please allow microphone access.');
    console.error('Recording error:', err);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  isRecording = false;
  clearInterval(recTimerInterval);

  document.getElementById('recBtn').classList.remove('recording');
  document.getElementById('recBtn').textContent = '‚è∫';
  document.getElementById('recIndicator').classList.remove('show');
}

function updateRecTimer() {
  const elapsed = Math.floor((Date.now() - recStartTime) / 1000);
  const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  document.getElementById('recTimer').textContent = `${m}:${s}`;
}

function getSupportedMime() {
  const types = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm','video/mp4'];
  for (const t of types) { if (MediaRecorder.isTypeSupported(t)) return t; }
  return 'video/webm';
}
</script>

<script>
// =============================================
// EDITOR & SCRIPTS
// =============================================
function openEditor(id) {
  editingScriptId = id || null;
  const modal = document.getElementById('editorModal');
  const nameInput = document.getElementById('scriptNameInput');
  const textarea = document.getElementById('scriptTextarea');
  const title = document.getElementById('editorTitle');

  if (id) {
    dbGet(id).then(s => {
      if (s) { nameInput.value = s.title; textarea.value = s.text; title.textContent = 'Edit Script'; }
      modal.classList.add('show');
    });
  } else {
    nameInput.value = ''; textarea.value = ''; title.textContent = 'New Script';
    modal.classList.add('show');
  }
}
function closeEditor() { document.getElementById('editorModal').classList.remove('show'); }

async function saveScript() {
  const name = document.getElementById('scriptNameInput').value.trim() || 'Untitled';
  const text = document.getElementById('scriptTextarea').value;
  if (!text.trim()) { alert('Please enter script text'); return; }
  const script = { id: editingScriptId || 'script_'+Date.now(), title: name, text, updated: Date.now() };
  await dbPut(script);
  currentScriptId = script.id;
  loadScriptToPrompter(script);
  closeEditor();
}

function loadScriptToPrompter(script) {
  const el = document.getElementById('scrollContent');
  const empty = document.getElementById('emptyState');
  if (empty) empty.style.display = 'none';
  el.textContent = script.text;
  resetScroll();
  document.title = script.title + ' ‚Äî WOTG Teleprompter';
}

async function openScripts() {
  const modal = document.getElementById('scriptsModal');
  const list = document.getElementById('scriptsList');
  const scripts = await dbGetAll();
  if (scripts.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:40px;opacity:.5">No saved scripts yet</div>';
  } else {
    list.innerHTML = scripts.map(s => `
      <div class="script-item" onclick="loadScript('${s.id}')">
        <div class="title">${esc(s.title)}</div>
        <div class="date">${new Date(s.updated).toLocaleDateString()}</div>
        <button class="del-btn" onclick="event.stopPropagation();deleteScript('${s.id}')" title="Delete">üóë</button>
        <button class="del-btn" onclick="event.stopPropagation();closeScripts();openEditor('${s.id}')" title="Edit" style="color:var(--accent)">‚úèÔ∏è</button>
      </div>
    `).join('');
  }
  modal.classList.add('show');
}
function closeScripts() { document.getElementById('scriptsModal').classList.remove('show'); }

async function loadScript(id) {
  const s = await dbGet(id);
  if (s) { currentScriptId = id; loadScriptToPrompter(s); closeScripts(); }
}
async function deleteScript(id) {
  if (!confirm('Delete this script?')) return;
  await dbDelete(id); openScripts();
}
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// =============================================
// TOUCH & KEYBOARD CONTROLS
// =============================================
let touchStartY = 0, touchStartScrollY = 0;

document.getElementById('scrollArea').addEventListener('touchstart', e => {
  if (isPlaying) return;
  touchStartY = e.touches[0].clientY;
  touchStartScrollY = scrollY;
}, { passive: true });

document.getElementById('scrollArea').addEventListener('touchmove', e => {
  if (isPlaying) return;
  scrollY = Math.max(0, touchStartScrollY + (touchStartY - e.touches[0].clientY));
  applyTransform();
}, { passive: true });

// Double-tap play/pause
let lastTap = 0;
document.getElementById('scrollArea').addEventListener('touchend', () => {
  const now = Date.now();
  if (now - lastTap < 300) togglePlay();
  lastTap = now;
});

// =============================================
// BLUETOOTH REMOTE + KEYBOARD HANDLER
// =============================================
// Desview & common BT remotes send as HID keyboard.
// Common mappings: joystick/dpad=arrows, center=Enter/Space,
// volume keys, media keys, Page Up/Down, etc.
// We also support Gamepad API for BT game controllers.

// Customizable key map (stored in localStorage)
const defaultKeyMap = {
  // action: [list of key names that trigger it]
  scrollForward:  ['ArrowDown','ArrowRight','PageDown','VolumeDown','AudioVolumeDown','j','J'],
  scrollBackward: ['ArrowUp','ArrowLeft','PageUp','VolumeUp','AudioVolumeUp','k','K'],
  playPause:      [' ','Enter','MediaPlayPause','p','P'],
  reset:          ['Home','r','R','0'],
  speedUp:        [']','+','='],
  speedDown:      ['[','-','_'],
  mirror:         ['m','M'],
  camera:         ['c','C'],
  record:         ['MediaRecord','F9'],
  toggleUI:       ['h','H','F11']
};

function getKeyMap() {
  return JSON.parse(localStorage.getItem('tp_keymap') || 'null') || {...defaultKeyMap};
}

function findAction(key) {
  const km = getKeyMap();
  for (const [action, keys] of Object.entries(km)) {
    if (keys.includes(key)) return action;
  }
  return null;
}

function executeAction(action) {
  switch(action) {
    case 'scrollForward':  nudge(1); break;
    case 'scrollBackward': nudge(-1); break;
    case 'playPause':      togglePlay(); break;
    case 'reset':          resetScroll(); break;
    case 'speedUp':        changeSpeed(0.5); break;
    case 'speedDown':      changeSpeed(-0.5); break;
    case 'mirror':         toggleMirror(); break;
    case 'camera':         toggleCamera(); break;
    case 'record':         toggleRecording(); break;
    case 'toggleUI':       toggleToolbar(); break;
  }
}

// Key debug mode ‚Äî shows what keys are being received
let keyDebugMode = false;
const keyDebugEl = document.createElement('div');
keyDebugEl.id = 'keyDebug';
keyDebugEl.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:300;background:rgba(0,0,0,.9);color:#4fc3f7;padding:20px 32px;border-radius:16px;font-size:18px;text-align:center;display:none;border:2px solid #4fc3f7;pointer-events:none;font-family:monospace;max-width:90vw;';
document.body.appendChild(keyDebugEl);

function showKeyDebug(e) {
  if (!keyDebugMode) return;
  keyDebugEl.style.display = 'block';
  keyDebugEl.innerHTML = `
    <div style="font-size:12px;opacity:.6;margin-bottom:6px">üéÆ Key Debug Mode</div>
    <div style="font-size:28px;margin-bottom:8px">${e.key === ' ' ? 'Space' : e.key}</div>
    <div style="font-size:13px;opacity:.7">code: ${e.code} ¬∑ keyCode: ${e.keyCode}</div>
    <div style="font-size:13px;color:#4caf50;margin-top:6px">‚Üí ${findAction(e.key) || 'unmapped'}</div>
  `;
  clearTimeout(keyDebugEl._timer);
  keyDebugEl._timer = setTimeout(() => { keyDebugEl.style.display = 'none'; }, 2000);
}

function toggleKeyDebug() {
  keyDebugMode = !keyDebugMode;
  const btn = document.getElementById('keyDebugBtn');
  if (btn) btn.classList.toggle('active', keyDebugMode);
  if (!keyDebugMode) keyDebugEl.style.display = 'none';
}

// Main keyboard/remote handler
document.addEventListener('keydown', e => {
  // Skip when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  // Show debug overlay
  showKeyDebug(e);

  // Escape always closes modals
  if (e.key === 'Escape') { closeEditor(); closeScripts(); closeSettings(); return; }

  const action = findAction(e.key);
  if (action) {
    e.preventDefault();
    executeAction(action);
  }
});

// Also handle volume button events that some BT remotes send
// Volume keys on mobile may not fire keydown, so we listen for these too
document.addEventListener('volumeupbutton', () => nudge(-1), false);
document.addEventListener('volumedownbutton', () => nudge(1), false);

// Gamepad API for BT game controllers
let gamepadPollInterval = null;
function startGamepadPoll() {
  if (gamepadPollInterval) return;
  gamepadPollInterval = setInterval(() => {
    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
    for (const gp of gamepads) {
      if (!gp) continue;
      // D-pad or analog stick
      const axes = gp.axes;
      if (axes[1] < -0.5) nudge(-1);  // up
      if (axes[1] > 0.5)  nudge(1);   // down
      // Buttons: 0=A(play), 1=B, 2=X, 3=Y
      if (gp.buttons[0] && gp.buttons[0].pressed) togglePlay();
      if (gp.buttons[9] && gp.buttons[9].pressed) togglePlay(); // start
    }
  }, 200);
}

window.addEventListener('gamepadconnected', e => {
  console.log('Gamepad connected:', e.gamepad.id);
  startGamepadPoll();
});
window.addEventListener('gamepaddisconnected', () => {
  clearInterval(gamepadPollInterval);
  gamepadPollInterval = null;
});

// Mouse wheel
document.getElementById('scrollArea').addEventListener('wheel', e => {
  if (isPlaying) return;
  scrollY = Math.max(0, scrollY + e.deltaY);
  applyTransform();
}, { passive: true });

// =============================================
// PWA INSTALL
// =============================================
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Show install banner if not dismissed
  if (!localStorage.getItem('tp_install_dismissed')) {
    document.getElementById('installBanner').classList.add('show');
  }
});

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(r => {
      if (r.outcome === 'accepted') localStorage.setItem('tp_install_dismissed', '1');
      deferredPrompt = null;
      document.getElementById('installBanner').classList.remove('show');
    });
  } else {
    // Fallback: redirect to install page
    window.location.href = '/install.html';
  }
}

function dismissInstall() {
  document.getElementById('installBanner').classList.remove('show');
  localStorage.setItem('tp_install_dismissed', '1');
}

// =============================================
// SERVICE WORKER REGISTRATION
// =============================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.log('SW registered:', reg.scope);
    }).catch(err => console.log('SW failed:', err));
  });
}

// =============================================
// INIT
// =============================================
async function init() {
  await openDB();
  loadSettings();

  // Restore preferences
  isMirror = localStorage.getItem('tp_mirror') === 'true';
  if (isMirror) document.getElementById('mirrorBtn').classList.add('active');

  isLight = localStorage.getItem('tp_theme') === 'light';
  if (isLight) { document.body.classList.add('light'); document.getElementById('themeBtn').textContent = '‚òÄÔ∏è'; }

  const savedSpeed = localStorage.getItem('tp_speed');
  if (savedSpeed) { speed = parseFloat(savedSpeed); document.getElementById('speedDisplay').textContent = speed%1===0?speed:speed.toFixed(1); }

  // Load last script
  const scripts = await dbGetAll();
  if (scripts.length > 0) { currentScriptId = scripts[0].id; loadScriptToPrompter(scripts[0]); }
}

init();
</script>
</body>
</html>
